<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Panel - Arisan UGM (Super Control)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #FF4785; 
            --primary-dark: #db2777;
            --primary-soft: #FFF0F5;
            --secondary: #6366F1; /* Indigo untuk Edit */
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F3F4F6;
            --card: #FFFFFF;
            --text: #1F2937;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 100px;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; text-align: center;
            background: linear-gradient(135deg, #FFF0F5 0%, #FFFFFF 100%);
        }
        .login-card {
            background: white; padding: 40px 30px; border-radius: 24px;
            box-shadow: var(--shadow-lg); width: 100%; max-width: 380px;
        }
        .login-icon {
            width: 70px; height: 70px; background: var(--primary-soft);
            color: var(--primary); border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 2rem;
            margin: 0 auto 20px;
        }
        .btn-google {
            background: #111827; color: white; width: 100%; padding: 16px;
            border-radius: 14px; border: none; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: transform 0.2s; margin-top: 25px;
        }
        .btn-google:active { transform: scale(0.98); }

        /* --- DASHBOARD --- */
        #dashboard { display: none; max-width: 600px; margin: 0 auto; padding: 20px; }

        /* Header */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
        }
        .admin-title { font-size: 1.5rem; font-weight: 800; color: var(--text); }
        .btn-logout {
            background: #FEE2E2; color: var(--danger); border: none;
            padding: 8px 16px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; cursor: pointer;
        }

        /* STATUS INDICATOR */
        .status-indicator {
            background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .status-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-on { background: #10B981; box-shadow: 0 0 12px #10B981; animation: pulse 2s infinite; }
        .status-off { background: #9CA3AF; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* CONFIG BUTTON */
        .btn-settings {
            background: white; border: 1px solid var(--border); color: var(--text);
            padding: 12px; border-radius: 14px; width: 100%; margin-bottom: 20px;
            font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; box-shadow: var(--shadow);
        }

        /* Month Selector Card */
        .month-card {
            background: var(--card); padding: 24px; border-radius: 24px;
            box-shadow: var(--shadow); margin-bottom: 24px;
            border: 1px solid white;
        }
        
        .month-actions { display: flex; gap: 10px; margin-bottom: 20px; }
        select {
            flex: 1; padding: 14px; border-radius: 14px; border: 1px solid #E5E7EB;
            font-family: inherit; font-size: 1rem; font-weight: 600; outline: none;
            background: #F9FAFB; appearance: none; min-width: 150px; cursor: pointer;
        }
        .btn-add-month { 
            width: 50px; background: #E5E7EB; color: #374151; border: none; 
            border-radius: 14px; font-size: 1.4rem; cursor: pointer; 
        }
        
        /* Control Buttons */
        .control-group { display: flex; flex-direction: column; gap: 12px; }

        .btn-play-arisan {
            background: linear-gradient(135deg, #FF4785 0%, #FF8EB3 100%); 
            color: white; border: none; border-radius: 16px;
            font-weight: 700; padding: 18px; width: 100%; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; box-shadow: 0 8px 20px -5px rgba(255, 71, 133, 0.4);
            transition: transform 0.2s;
        }
        .btn-play-arisan:active { transform: scale(0.98); }

        .btn-stop-arisan {
            background: white; border: 2px solid #EF4444; color: #EF4444;
            border-radius: 16px; font-weight: 700; padding: 16px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .btn-stop-arisan:active { background: #FEF2F2; transform: scale(0.98); }

        /* Stats */
        .status-summary {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 24px;
        }
        .sum-card {
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: var(--shadow); text-align: center; border: 1px solid white;
        }
        .sum-num { font-size: 1.8rem; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        .sum-lbl { font-size: 0.75rem; color: #9CA3AF; font-weight: 700; letter-spacing: 0.5px; }

        /* Member List */
        .list-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding: 0 5px;
        }
        .list-title { font-size: 1.1rem; font-weight: 700; }

        .member-item {
            background: var(--card); padding: 16px; border-radius: 18px;
            margin-bottom: 12px; display: flex; align-items: center; gap: 12px;
            box-shadow: var(--shadow); border: 1px solid white;
            transition: all 0.2s; position: relative;
        }
        .member-item.paid { border-left: 6px solid var(--success); }
        .member-item.unpaid { border-left: 6px solid #E5E7EB; }

        .m-avatar {
            width: 42px; height: 42px; background: #F3F4F6; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: #6B7280; font-size: 1rem; flex-shrink: 0;
        }
        .m-info { flex: 1; }
        .m-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 2px; }
        .m-sub { font-size: 0.75rem; color: #6B7280; }

        /* Actions in List */
        .action-area { display: flex; align-items: center; gap: 8px; }
        
        .btn-action {
            width: 34px; height: 34px; border-radius: 10px; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        .btn-edit { background: #EEF2FF; color: var(--secondary); }
        .btn-kick { background: #FEF2F2; color: var(--danger); }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E5E7EB; transition: .4s; border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .toggle-input:checked + .toggle-slider { background-color: var(--success); }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* FAB */
        .fab-add {
            position: fixed; bottom: 25px; right: 25px;
            background: var(--primary); color: white; width: 60px; height: 60px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 10px 30px rgba(255, 71, 133, 0.5);
            cursor: pointer; transition: transform 0.2s; z-index: 100;
        }
        .fab-add:active { transform: scale(0.9); }

        /* --- MODAL SYSTEM (REMASTERED) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(8px); /* Efek Blur Belakang */
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.active { display: flex; opacity: 1; }
        
        .modal-content {
            background: white; width: 90%; max-width: 450px;
            border-radius: 28px; padding: 30px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: left;
        }
        .modal.active .modal-content { transform: scale(1); }

        .modal-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 5px; color: var(--text); }
        .modal-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 25px; line-height: 1.5; }

        .inp-group { margin-bottom: 18px; }
        .inp-label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; color: #374151; }
        .inp-field {
            width: 100%; padding: 16px; border-radius: 16px; border: 2px solid #F3F4F6;
            font-family: inherit; font-size: 1rem; outline: none; background: #F9FAFB;
            transition: all 0.2s;
        }
        .inp-field:focus { border-color: var(--primary); background: white; }

        .btn-row { display: flex; gap: 12px; margin-top: 10px; }
        .btn-full { width: 100%; }
        
        .btn-save {
            background: var(--text); color: white; padding: 16px; flex: 2;
            border-radius: 16px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer;
        }
        .btn-cancel {
            background: #F3F4F6; color: var(--text-muted); padding: 16px; flex: 1;
            border-radius: 16px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer;
        }

        /* Warning Specifics */
        .modal-center { text-align: center; }
        .warning-icon { font-size: 3.5rem; color: var(--warning); margin-bottom: 15px; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
        
        .btn-confirm-play { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 16px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(255, 71, 133, 0.4); }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-icon"><i class="fa-solid fa-shield-halved"></i></div>
            <h2 style="margin:0 0 10px 0;">Admin Panel</h2>
            <p style="color:#6B7280; font-size:0.9rem; margin:0;">Kelola data arisan dan keuangan dengan mudah.</p>
            
            <button class="btn-google" onclick="login()">
                <i class="fa-brands fa-google"></i> Masuk dengan Google
            </button>
        </div>
    </div>

    <div id="dashboard">
        <div class="top-bar">
            <div>
                <div class="admin-title">Halo, Admin ðŸ‘‹</div>
                <div style="font-size:0.85rem; color:#6B7280;">Control Center</div>
            </div>
            <button class="btn-logout" onclick="logout()">LOGOUT</button>
        </div>

        <div class="status-indicator">
            <div>
                <div style="font-size:0.75rem; color:#6B7280; font-weight:600;">STATUS PUBLIK</div>
                <div id="public-status-text" style="font-weight:800; font-size:1.1rem;">MEMUAT...</div>
            </div>
            <div id="public-status-dot" class="status-dot status-off"></div>
        </div>

        <button class="btn-settings" onclick="openFinancialModal()">
            <i class="fa-solid fa-gear"></i> Atur Nominal Uang (Index)
        </button>

        <div class="month-card">
            <label class="month-label">PERIODE ARISAN</label>
            <div class="month-actions">
                <select id="periodSelect" onchange="changePeriod()">
                    </select>
                <button class="btn-icon btn-add-month" onclick="showAddMonthModal()" title="Tambah Periode">+</button>
            </div>
            
            <div class="control-group">
                <button class="btn-play-arisan" onclick="validateAndPlay()">
                    <i class="fa-solid fa-play"></i> MULAI / LANJUT KOCOK
                </button>
                
                <button class="btn-stop-arisan" onclick="stopGame()">
                    <i class="fa-solid fa-stop"></i> JEDA / TUTUP SESI
                </button>
            </div>
        </div>

        <div class="status-summary">
            <div class="sum-card">
                <div class="sum-num" style="color:var(--success);" id="count-paid">0</div>
                <div class="sum-lbl">SUDAH LUNAS</div>
            </div>
            <div class="sum-card">
                <div class="sum-num" style="color:#EF4444;" id="count-unpaid">0</div>
                <div class="sum-lbl">BELUM BAYAR</div>
            </div>
        </div>

        <div class="list-header">
            <div class="list-title">Daftar Anggota</div>
            <div style="font-size:0.85rem; color:#6B7280;"><span id="total-member">0</span> Orang</div>
        </div>

        <div id="member-list">
            <div style="text-align:center; padding:40px; color:#9ca3af;">Memuat data...</div>
        </div>
    </div>

    <div id="fab" class="fab-add" onclick="showAddMemberModal()">+</div>

    <div id="modal-member" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Tambah Anggota</h3>
            <p class="modal-desc">Pastikan nama dan nominal benar.</p>
            
            <div class="inp-group">
                <label class="inp-label">Nama Lengkap</label>
                <input type="text" id="newMemName" class="inp-field" placeholder="Contoh: Mba Dina">
            </div>
            <div class="inp-group">
                <label class="inp-label">Keterangan / Nama Anak</label>
                <input type="text" id="newMemChild" class="inp-field" placeholder="Opsional (misal nama anak)">
            </div>
            <div class="inp-group">
                <label class="inp-label">Nominal Arisan</label>
                <select id="newMemNominal" class="inp-field">
                    <option value="225.000">Rp 225.000</option>
                    <option value="200.000">Rp 200.000</option>
                </select>
            </div>
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeModal('modal-member')">Batal</button>
                <button class="btn-save" onclick="addNewMember()">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-member" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Edit Anggota</h3>
            <p class="modal-desc">Perbarui data anggota yang salah.</p>
            
            <input type="hidden" id="editMemKey"> <div class="inp-group">
                <label class="inp-label">Nama Lengkap</label>
                <input type="text" id="editMemName" class="inp-field">
            </div>
            <div class="inp-group">
                <label class="inp-label">Keterangan / Nama Anak</label>
                <input type="text" id="editMemChild" class="inp-field">
            </div>
            <div class="inp-group">
                <label class="inp-label">Nominal Arisan</label>
                <select id="editMemNominal" class="inp-field">
                    <option value="225.000">Rp 225.000</option>
                    <option value="200.000">Rp 200.000</option>
                </select>
            </div>
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeModal('modal-edit-member')">Batal</button>
                <button class="btn-save" style="background:var(--secondary);" onclick="saveEditMember()">Update</button>
            </div>
        </div>
    </div>

    <div id="modal-financial" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Pengaturan Nominal</h3>
            <p class="modal-desc">Angka ini akan tampil di halaman depan (Index) member.</p>
            
            <div class="inp-group">
                <label class="inp-label">Nominal Uang Arisan (Rp)</label>
                <input type="text" id="confArisan" class="inp-field" placeholder="200.000">
            </div>
            <div class="inp-group">
                <label class="inp-label">Nominal Tabungan Wajib (Rp)</label>
                <input type="text" id="confTabungan" class="inp-field" placeholder="25.000">
            </div>
            
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeModal('modal-financial')">Batal</button>
                <button class="btn-save" onclick="saveFinancials()">Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="modal-month" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Buka Bulan Baru</h3>
            <p class="modal-desc">Otomatis menyalin data anggota bulan lalu & mereset status pembayaran.</p>
            
            <div class="inp-group">
                <label class="inp-label">Pilih Bulan</label>
                <select id="newMonthSelect" class="inp-field">
                    <option value="jan">Januari</option><option value="feb">Februari</option>
                    <option value="mar">Maret</option><option value="apr">April</option>
                    <option value="mei">Mei</option><option value="jun">Juni</option>
                    <option value="jul">Juli</option><option value="agu">Agustus</option>
                    <option value="sep">September</option><option value="okt">Oktober</option>
                    <option value="nov">November</option><option value="des">Desember</option>
                </select>
            </div>
            <div class="inp-group">
                <label class="inp-label">Pilih Tahun</label>
                <select id="newYearSelect" class="inp-field">
                    <option value="2026">2026</option><option value="2027">2027</option>
                    <option value="2028">2028</option><option value="2029">2029</option>
                    <option value="2030">2030</option>
                </select>
            </div>
            <div class="btn-row">
                <button class="btn-cancel" onclick="closeModal('modal-month')">Batal</button>
                <button class="btn-save" onclick="createNewPeriod()">Buat Periode</button>
            </div>
        </div>
    </div>

    <div id="modal-play" class="modal">
        <div class="modal-content modal-center">
            <div class="warning-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h2 style="margin-top:0; color:#1F2937;">Peringatan Pembayaran</h2>
            <div id="play-warning-msg" class="modal-desc" style="font-size:1rem; margin-bottom:30px;"></div>
            
            <button class="btn-confirm-play" onclick="proceedToGame()">
                Buka Akses & Mulai <i class="fa-solid fa-arrow-right"></i>
            </button>
            <button onclick="closeModal('modal-play')" style="background:none; border:none; margin-top:15px; color:#6B7280; font-weight:600; cursor:pointer;">Periksa Lagi</button>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB8rMfcf-jSO8t8T145m6vnZQq-pFjtXjI",
            authDomain: "billy-d4379.firebaseapp.com",
            projectId: "billy-d4379",
            storageBucket: "billy-d4379.firebasestorage.app",
            messagingSenderId: "68495109677",
            appId: "1:68495109677:web:ad1d20544dcbd0b71a52a4",
            measurementId: "G-L8JMKLVPQ9",
            databaseURL: "https://billy-d4379-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        
        const ALLOWED_EMAIL = "ornaclealternatifa@gmail.com";

        let currentPeriod = 'jan_2026'; 
        let participantsCache = [];
        let globalUnpaidCount = 0; 
        let isAppLive = false;

        // --- GLOBAL: CLICK OUTSIDE TO CLOSE ---
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // --- AUTH ---
        function login() {
            auth.signInWithPopup(provider).then((result) => {
                if (result.user.email === ALLOWED_EMAIL) initAdmin();
                else { alert("Akses Ditolak! Hanya Admin yang boleh masuk."); auth.signOut(); }
            }).catch(e => alert(e.message));
        }

        function logout() {
            auth.signOut().then(() => window.location.href = "index.html");
        }

        auth.onAuthStateChanged(user => {
            if (user && user.email === ALLOWED_EMAIL) {
                initAdmin();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('fab').style.display = 'none';
            }
        });

        function initAdmin() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('fab').style.display = 'flex';
            loadPeriodList();
            listenToAppStatus();
        }

        // --- MONITOR STATUS ---
        function listenToAppStatus() {
            db.ref('appStatus').on('value', snap => {
                const status = snap.val() || { live: false, period: '' };
                isAppLive = status.live;
                
                const dot = document.getElementById('public-status-dot');
                const text = document.getElementById('public-status-text');

                if(isAppLive) {
                    dot.className = 'status-dot status-on';
                    text.innerText = "ðŸŸ¢ SEDANG LIVE";
                    text.style.color = "#10B981";
                } else {
                    dot.className = 'status-dot status-off';
                    text.innerText = "ðŸ”´ TERTUTUP (OFFLINE)";
                    text.style.color = "#6B7280";
                }
            });
        }

        // --- PERIODS ---
        function loadPeriodList() {
            db.ref('participants').on('value', snapshot => {
                const data = snapshot.val();
                const select = document.getElementById('periodSelect');
                select.innerHTML = "";
                
                if(!data) {
                    select.innerHTML = "<option value='jan_2026'>Januari 2026 (Default)</option>";
                    loadMembers('jan_2026');
                    return;
                }

                Object.keys(data).forEach(key => {
                    const label = formatPeriodName(key);
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = label;
                    select.appendChild(opt);
                });

                if(data[currentPeriod]) select.value = currentPeriod;
                else {
                    const keys = Object.keys(data);
                    select.value = keys[keys.length - 1];
                    currentPeriod = keys[keys.length - 1];
                }
                loadMembers(select.value);
            });
        }

        function formatPeriodName(key) {
            const [month, year] = key.split('_');
            const months = {jan:'Januari', feb:'Februari', mar:'Maret', apr:'April', mei:'Mei', jun:'Juni', jul:'Juli', agu:'Agustus', sep:'September', okt:'Oktober', nov:'November', des:'Desember'};
            return `${months[month] || month} ${year}`;
        }

        function changePeriod() {
            currentPeriod = document.getElementById('periodSelect').value;
            loadMembers(currentPeriod);
        }

        // --- MEMBERS ---
        function loadMembers(period) {
            currentPeriod = period;
            const container = document.getElementById('member-list');
            
            db.ref(`participants/${period}`).on('value', snapshot => {
                const data = snapshot.val();
                container.innerHTML = "";
                let paidCount = 0;
                let totalCount = 0;

                if (!data) {
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">Belum ada data.<br>Silakan tambah anggota.</div>`;
                    updateStats(0, 0);
                    return;
                }

                const members = Object.entries(data).map(([k, v]) => ({key:k, ...v}));
                participantsCache = members;
                totalCount = members.length;

                members.forEach(m => {
                    if(m.status === 'lunas') paidCount++;
                    const isPaid = m.status === 'lunas';
                    
                    const div = document.createElement('div');
                    div.className = `member-item ${isPaid ? 'paid' : 'unpaid'}`;
                    div.innerHTML = `
                        <div class="m-avatar">${m.name.charAt(0)}</div>
                        <div class="m-info">
                            <div class="m-name">${m.name}</div>
                            <div class="m-sub">${m.child || '-'} | Rp ${m.nominal}</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="toggle-input" ${isPaid ? 'checked' : ''} onchange="togglePay('${m.key}', this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="action-area">
                            <button class="btn-action btn-edit" onclick="openEditModal('${m.key}', '${m.name}', '${m.child || ''}', '${m.nominal}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-action btn-kick" onclick="kickMember('${m.key}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                updateStats(paidCount, totalCount);
            });
        }

        function updateStats(paid, total) {
            globalUnpaidCount = total - paid;
            document.getElementById('count-paid').innerText = paid;
            document.getElementById('count-unpaid').innerText = globalUnpaidCount;
            document.getElementById('total-member').innerText = total;
        }

        function togglePay(key, isChecked) {
            db.ref(`participants/${currentPeriod}/${key}`).update({ status: isChecked ? 'lunas' : 'belum' });
        }

        function kickMember(key) {
            if(confirm("Hapus anggota ini dari periode ini?")) {
                db.ref(`participants/${currentPeriod}/${key}`).remove();
            }
        }

        // --- NEW: EDIT MEMBER FEATURE ---
        function openEditModal(key, name, child, nominal) {
            document.getElementById('editMemKey').value = key;
            document.getElementById('editMemName').value = name;
            document.getElementById('editMemChild').value = child;
            document.getElementById('editMemNominal').value = nominal;
            document.getElementById('modal-edit-member').classList.add('active');
        }

        function saveEditMember() {
            const key = document.getElementById('editMemKey').value;
            const name = document.getElementById('editMemName').value;
            const child = document.getElementById('editMemChild').value;
            const nominal = document.getElementById('editMemNominal').value;

            if(!name) return alert("Nama tidak boleh kosong");

            db.ref(`participants/${currentPeriod}/${key}`).update({
                name: name,
                child: child,
                nominal: nominal
            }).then(() => {
                closeModal('modal-edit-member');
            });
        }

        // --- NEW: FINANCIAL SETTINGS (CUSTOM INDEX) ---
        function openFinancialModal() {
            db.ref('appSettings/financials').once('value', snap => {
                const data = snap.val() || { arisan: "200.000", tabungan: "25.000" };
                document.getElementById('confArisan').value = data.arisan;
                document.getElementById('confTabungan').value = data.tabungan;
                document.getElementById('modal-financial').classList.add('active');
            });
        }

        function saveFinancials() {
            const arisan = document.getElementById('confArisan').value;
            const tabungan = document.getElementById('confTabungan').value;
            
            db.ref('appSettings/financials').set({
                arisan: arisan,
                tabungan: tabungan
            }).then(() => {
                alert("Nominal berhasil diperbarui!");
                closeModal('modal-financial');
            });
        }

        // --- PLAY CONTROL ---
        function validateAndPlay() {
            if (globalUnpaidCount > 0) {
                const periodName = formatPeriodName(currentPeriod);
                const msg = `Masih ada <b style="color:#EF4444;">${globalUnpaidCount}</b> anggota <b>BELUM BAYAR</b> di periode ${periodName}.<br>Yakin ingin LIVE?`;
                document.getElementById('play-warning-msg').innerHTML = msg;
                document.getElementById('modal-play').classList.add('active');
            } else {
                if(confirm("Semua lunas. Buka akses publik dan mulai kocokan?")) proceedToGame();
            }
        }

        function proceedToGame() {
            db.ref('appStatus').set({ live: true, period: currentPeriod });
            window.open(`kocok-asli.html?period=${currentPeriod}`, '_blank');
            closeModal('modal-play');
        }

        function stopGame() {
            if(!isAppLive) return alert("Status sudah tertutup (OFFLINE).");
            if(confirm("TUTUP sesi arisan sekarang?\nPublik akan kembali melihat layar tunggu.")) {
                db.ref('appStatus').update({ live: false });
            }
        }

        // --- ADD DATA ---
        function createNewPeriod() {
            const m = document.getElementById('newMonthSelect').value;
            const y = document.getElementById('newYearSelect').value;
            const newKey = `${m}_${y}`;

            db.ref(`participants/${newKey}`).once('value', snap => {
                if(snap.exists()) return alert("Periode ini sudah ada!");
                
                if(participantsCache.length > 0) {
                    const updates = {};
                    participantsCache.forEach(p => {
                        updates[p.key] = {
                            name: p.name, child: p.child || "", nominal: p.nominal, status: "belum"
                        };
                    });
                    db.ref(`participants/${newKey}`).update(updates);
                } else {
                    db.ref(`participants/${newKey}`).set({ created: true });
                }
                
                closeModal('modal-month');
                setTimeout(() => {
                    document.getElementById('periodSelect').value = newKey;
                    loadMembers(newKey);
                }, 1000);
            });
        }

        function addNewMember() {
            const name = document.getElementById('newMemName').value;
            const child = document.getElementById('newMemChild').value;
            const nominal = document.getElementById('newMemNominal').value;

            if(!name) return alert("Nama wajib diisi!");

            db.ref(`participants/${currentPeriod}`).push({
                name: name, child: child, nominal: nominal, status: "belum"
            });
            
            closeModal('modal-member');
            document.getElementById('newMemName').value = "";
            document.getElementById('newMemChild').value = "";
        }

        // UTILS
        function showAddMonthModal() { document.getElementById('modal-month').classList.add('active'); }
        function showAddMemberModal() { document.getElementById('modal-member').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // --- LOAD FINANCIALS (DARI ADMIN) ---
        function loadFinancials() {
            // Mengambil data dari path yang sama dengan tempat Admin menyimpan
            db.ref('appSettings/financials').on('value', (snapshot) => {
                const data = snapshot.val();
                
                // Jika data ada, update tampilan
                if (data) {
                    // Format angka agar rapi (opsional, tapi disarankan)
                    // Jika admin input "200.000", langsung tampilkan.
                    // Jika mau aman, pastikan formatnya string "Rp ..."
                    
                    // Cek apakah input admin sudah ada "Rp" atau belum
                    const arisanText = data.arisan.toString().includes('Rp') ? data.arisan : 'Rp ' + data.arisan;
                    const tabunganText = data.tabungan.toString().includes('Rp') ? data.tabungan : 'Rp ' + data.tabungan;

                    document.getElementById('displayArisan').innerText = arisanText;
                    document.getElementById('displayTabungan').innerText = tabunganText;
                }
            });
        }

        // --- UPDATE BAGIAN INIT ---
        document.addEventListener("DOMContentLoaded", () => {
            refreshData(); 
            loadFinancials(); // <--- Panggil fungsi ini agar otomatis jalan
        });
    </script>
</body>
</html>
